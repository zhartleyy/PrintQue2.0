{% extends "base.html" %}

{% block title %}Print History - PrintQue{% endblock %}

{% block extra_styles %}
<style>
    .history-container {
        max-width: 1400px;
        margin: 0 auto;
        /* FIX: Add top padding for a buffer between header and content */
        padding-top: 30px;
    }
    
    .history-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .history-stat-card {
        background: var(--bg-secondary, #f8f9fa);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        border: 1px solid var(--border-color, #e9ecef);
        transition: all 0.3s ease;
    }
    
    [data-theme="dark"] .history-stat-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .history-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .history-stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #3b82f6;
        margin-bottom: 5px;
    }
    
    [data-theme="dark"] .history-stat-value {
        color: #60a5fa;
    }
    
    .history-stat-label {
        font-size: 0.9rem;
        color: var(--text-secondary, #6c757d);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .history-filters {
        background: var(--bg-secondary, #f8f9fa);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color, #e9ecef);
    }
    
    [data-theme="dark"] .history-filters {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .filter-row {
        display: flex;
        gap: 15px;
        align-items: end;
        flex-wrap: wrap;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .history-table {
        background: var(--card-bg);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    [data-theme="dark"] .history-table {
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .table-responsive {
        border-radius: 12px;
        overflow-x: auto;
    }
    
    .history-table table {
        margin-bottom: 0;
    }
    
    .history-table th {
        background: var(--bg-secondary, #f8f9fa);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        padding: 15px;
        border-bottom: 2px solid var(--border-color, #e9ecef);
    }
    
    [data-theme="dark"] .history-table th {
        background: rgba(255, 255, 255, 0.05);
        border-bottom-color: rgba(255, 255, 255, 0.1);
    }
    
    .history-table td {
        padding: 12px 15px;
        vertical-align: middle;
    }
    
    .completion-date {
        font-size: 0.9rem;
        color: var(--text-secondary, #6c757d);
    }
    
    .printer-groups-badge {
        display: inline-block;
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        margin: 2px;
    }
    
    [data-theme="dark"] .printer-groups-badge {
        background: rgba(33, 150, 243, 0.2);
        color: #64b5f6;
    }
    
    .ejection-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .ejection-enabled {
        background: #d4edda;
        color: #155724;
    }
    
    .ejection-disabled {
        background: #f8d7da;
        color: #721c24;
    }
    
    [data-theme="dark"] .ejection-enabled {
        background: rgba(40, 167, 69, 0.2);
        color: #4caf50;
    }
    
    [data-theme="dark"] .ejection-disabled {
        background: rgba(220, 53, 69, 0.2);
        color: #f44336;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary, #6c757d);
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }
    
    .export-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-bottom: 20px;
    }

    .table-active {
        background-color: #f0f8ff !important;
    }
    
    .badge {
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 0.85em;
    }
    
    .badge-primary {
        background-color: #007bff;
        color: white;
    }
    
    .badge-warning {
        background-color: #ffc107;
        color: #212529;
    }
    
    .badge-success {
        background-color: #28a745;
        color: white;
    }
    
    #result-count {
        margin-bottom: 10px;
        color: #666;
        font-style: italic;
    }
    
    @media (max-width: 768px) {
        .filter-row {
            grid-template-columns: 1fr;
        }
        
        .date-inputs-row {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .filter-group {
            width: 100%;
        }
        
        .export-buttons {
            flex-direction: column;
        }
        
        .export-buttons button {
            width: 100%;
        }
        
        .history-table {
            font-size: 0.85rem;
        }
        
        .history-table th, .history-table td {
            padding: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="history-container">
    <h1 class="mb-4">Print History</h1>
    
    
    <div class="history-filters">
        <div class="filter-row">
            <div class="filter-group">
                <label for="date-filter" class="form-label">Date Range</label>
                <select class="form-select" id="date-filter">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            
            <div class="filter-group" id="custom-date-range" style="display: none;">
                <label class="form-label">Custom Date Range</label>
                <div class="d-flex gap-2">
                    <input type="date" class="form-control" id="start-date">
                    <input type="date" class="form-control" id="end-date">
                </div>
            </div>

            <div class="filter-group">
                <label for="status-filter">Status</label>
                <select class="form-control" id="status-filter">
                    <option value="all">All Orders</option>
                    <option value="active">Active Orders</option>
                    <option value="completed">Completed Orders</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="group-filter" class="form-label">Printer Group</label>
                <select class="form-select" id="group-filter">
                    <option value="all">All Groups</option>
                    </select>
            </div>
            
            <div class="filter-group">
                <label for="search-filter" class="form-label">Search</label>
                <input type="text" class="form-control" id="search-filter" placeholder="Search filename...">
            </div>
            
            <div class="filter-group">
                <button class="btn btn-primary" onclick="applyFilters()">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
                <button class="btn btn-secondary" onclick="resetFilters()">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </div>
    </div>
    
    <div class="export-buttons">
        <button class="btn btn-outline-primary" onclick="exportToCSV()">
            <i class="fas fa-file-csv"></i> Export to CSV
        </button>
        <button class="btn btn-outline-primary" onclick="exportToJSON()">
            <i class="fas fa-file-code"></i> Export to JSON
        </button>
    </div>
    
    <p id="result-count"></p>

    <div class="history-table">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Completed</th>
                        <th>Filename</th>
                        <th>Progress</th>
                        <th>Printer Groups</th>
                        <th>Filament Used</th>
                        <th>Ejection</th>
                        <th>Duration</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody id="history-tbody">
                    <tr><td colspan="10" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="empty-state" id="empty-state" style="display: none;">
            <i class="fas fa-history"></i>
            <h3>No Print History Found</h3>
            <p>Completed print jobs will appear here.</p>
        </div>
    </div>
    
    <div class="pagination-container" id="pagination-container">
        </div>
</div>

<script>
// Global variables
let allHistory = [];
let filteredHistory = [];
let currentPage = 1;
const itemsPerPage = 20;

// Auto-refresh timer
let refreshTimer = null;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadPrintHistory();
    setupEventListeners();
});

// Setup event listeners
function setupEventListeners() {
    document.getElementById('date-filter').addEventListener('change', function() {
        const customRange = document.getElementById('custom-date-range');
        customRange.style.display = this.value === 'custom' ? 'flex' : 'none';
    });

    document.getElementById('status-filter').addEventListener('change', applyFilters);
    document.getElementById('group-filter').addEventListener('change', applyFilters);
    document.getElementById('search-filter').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            applyFilters();
        }
    });
    document.getElementById('start-date').addEventListener('change', applyFilters);
    document.getElementById('end-date').addEventListener('change', applyFilters);
}

// Load print history from server
function loadPrintHistory(silent = false) {
    if (!silent) {
        // Show loading indicator only for manual refresh
        document.getElementById('history-tbody').innerHTML = 
            '<tr><td colspan="10" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
    }
    
    fetch('/api/print_history')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allHistory = data.history;
                
                // Update groups dropdown
                const groupFilter = document.getElementById('group-filter');
                const currentGroup = groupFilter.value;
                groupFilter.innerHTML = '<option value="all">All Groups</option>';
                data.groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    if (group === currentGroup) option.selected = true;
                    groupFilter.appendChild(option);
                });
                
                // Apply filters and display
                applyFilters();
                updateStatistics();
                checkAutoRefresh();
            } else {
                console.error('Failed to load print history:', data.error);
                if (!silent) {
                    document.getElementById('history-tbody').innerHTML = 
                        '<tr><td colspan="10" class="text-center text-danger">Failed to load history</td></tr>';
                }
            }
        })
        .catch(error => {
            console.error('Error loading print history:', error);
            if (!silent) {
                document.getElementById('history-tbody').innerHTML = 
                    '<tr><td colspan="10" class="text-center text-danger">Error loading history</td></tr>';
            }
        });
}

// Apply filters
function applyFilters() {
    const dateFilter = document.getElementById('date-filter').value;
    const groupFilter = document.getElementById('group-filter').value;
    const searchFilter = document.getElementById('search-filter').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    filteredHistory = allHistory.filter(item => {
        // Status filter
        if (statusFilter === 'active' && !item.is_active) return false;
        if (statusFilter === 'completed' && item.is_active) return false;
        
        // Group filter
        if (groupFilter !== 'all' && !item.groups.includes(groupFilter)) return false;
        
        // Search filter
        if (searchFilter && !item.filename.toLowerCase().includes(searchFilter)) return false;
        
        // Date filter (use created_at for active orders, completed_at for completed)
        const dateToCheck = item.completed_at || item.created_at;
        return filterByDate(dateToCheck, dateFilter, startDate, endDate);
    });
    
    // Update UI
    currentPage = 1;
    displayHistory();
    updatePagination();
    
    // Update result count
    document.getElementById('result-count').textContent = 
        `Showing ${filteredHistory.length} of ${allHistory.length} orders`;
}

// Apply date filter to an item
function filterByDate(dateString, filterType, startDate, endDate) {
    if (filterType === 'all') return true;
    
    const itemDate = new Date(dateString);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    switch (filterType) {
        case 'today':
            return itemDate >= today;
            
        case 'week':
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            return itemDate >= weekAgo;
            
        case 'month':
            const monthAgo = new Date(today);
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            return itemDate >= monthAgo;
            
        case 'custom':
            if (startDate && itemDate < new Date(startDate)) return false;
            if (endDate && itemDate > new Date(endDate + 'T23:59:59')) return false;
            return true;
            
        default:
            return true;
    }
}

// Display history in the table
function displayHistory() {
    const tbody = document.getElementById('history-tbody');
    const emptyState = document.getElementById('empty-state');
    
    if (filteredHistory.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    const start = (currentPage - 1) * itemsPerPage;
    const end = Math.min(start + itemsPerPage, filteredHistory.length);
    const pageItems = filteredHistory.slice(start, end);
    
    tbody.innerHTML = pageItems.map(item => {
        // Determine status display
        let statusBadge = '';
        let progressText = '';
        
        if (item.is_active) {
            // Active order
            const progress = item.sent ? Math.round((item.sent / item.quantity) * 100) : 0;
            statusBadge = `<span class="badge ${item.status === 'printing' ? 'badge-primary' : 'badge-warning'}">${item.status}</span>`;
            progressText = `${item.sent || 0}/${item.quantity} (${progress}%)`;
        } else {
            // Completed order
            statusBadge = '<span class="badge badge-success">completed</span>';
            progressText = `${item.quantity}/${item.quantity} (100%)`;
        }
        
        // Format dates
        const createdDate = item.created_at ? formatDate(item.created_at) : 'N/A';
        const completedDate = item.completed_at ? formatDate(item.completed_at) : 
                             (item.is_active ? '<em>In Progress</em>' : 'N/A');
        
        // Format duration
        const duration = item.duration_seconds ? formatDuration(item.duration_seconds) : 
                        (item.is_active ? '<em>Ongoing</em>' : 'N/A');
        
        // Row styling for active orders
        const rowClass = item.is_active ? 'table-active' : '';
        
        return `
            <tr class="${rowClass}">
                <td>${statusBadge}</td>
                <td>${createdDate}</td>
                <td>${completedDate}</td>
                <td>${escapeHtml(item.filename)}</td>
                <td>${progressText}</td>
                <td>${item.groups.map(g => `<span class="printer-groups-badge">${escapeHtml(g)}</span>`).join('')}</td>
                <td>${formatFilament(item.filament_g * (item.sent || item.quantity))}</td>
                <td>
                    <span class="ejection-badge ${item.ejection_enabled ? 'ejection-enabled' : 'ejection-disabled'}">
                        ${item.ejection_enabled ? 'Enabled' : 'Disabled'}
                    </span>
                </td>
                <td>${duration}</td>
                <td>${item.source || 'Unknown'}</td>
            </tr>
        `;
    }).join('');
}

// Check for active orders and enable auto-refresh
function checkAutoRefresh() {
    const hasActiveOrders = allHistory.some(item => item.is_active);
    
    if (hasActiveOrders && !refreshTimer) {
        // Start auto-refresh every 30 seconds
        refreshTimer = setInterval(() => {
            loadPrintHistory(true); // true = silent refresh
        }, 30000);
    } else if (!hasActiveOrders && refreshTimer) {
        // Stop auto-refresh if no active orders
        clearInterval(refreshTimer);
        refreshTimer = null;
    }
}

// Update statistics
function updateStatistics() {
    const completedOrders = allHistory.filter(item => !item.is_active);
    const activeOrders = allHistory.filter(item => item.is_active);
    
    const totalPrints = completedOrders.reduce((sum, item) => sum + item.quantity, 0);
    const activePrints = activeOrders.reduce((sum, item) => sum + (item.sent || 0), 0);
    const totalFilament = allHistory.reduce((sum, item) => {
        const count = item.is_active ? (item.sent || 0) : item.quantity;
        return sum + (item.filament_g * count);
    }, 0);
    const uniqueFiles = new Set(allHistory.map(item => item.filename)).size;
    
    // NOTE: The stat cards are removed from the HTML, 
    // but the JavaScript is kept to ensure no errors if it's referenced elsewhere.
    const totalPrintsEl = document.getElementById('total-prints');
    if (totalPrintsEl) totalPrintsEl.textContent = totalPrints.toLocaleString();
    
    const totalFilamentEl = document.getElementById('total-filament');
    if (totalFilamentEl) totalFilamentEl.textContent = formatFilament(totalFilament);
    
    const uniqueFilesEl = document.getElementById('unique-files');
    if (uniqueFilesEl) uniqueFilesEl.textContent = uniqueFiles.toLocaleString();
    
    const activeOrdersCard = document.getElementById('active-orders');
    if (activeOrdersCard) {
        activeOrdersCard.textContent = activeOrders.length;
    }
}

// Update pagination controls
function updatePagination() {
    const container = document.getElementById('pagination-container');
    const totalPages = Math.ceil(filteredHistory.length / itemsPerPage);
    
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '<nav><ul class="pagination">';
    
    // Previous button
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
    </li>`;
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    // Next button
    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
    </li>`;
    
    html += '</ul></nav>';
    container.innerHTML = html;
}

// Change page
function changePage(page) {
    const totalPages = Math.ceil(filteredHistory.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayHistory();
        updatePagination();
        window.scrollTo(0, 0);
    }
}

// Reset filters
function resetFilters() {
    document.getElementById('date-filter').value = 'all';
    document.getElementById('group-filter').value = 'all';
    document.getElementById('search-filter').value = '';
    document.getElementById('status-filter').value = 'all';
    document.getElementById('custom-date-range').style.display = 'none';
    document.getElementById('start-date').value = '';
    document.getElementById('end-date').value = '';
    applyFilters();
}

// Export to CSV
function exportToCSV() {
    // Collect all unique extra data keys across all history items
    const extraDataKeys = new Set();
    filteredHistory.forEach(item => {
        if (item.extra_data && typeof item.extra_data === 'object') {
            Object.keys(item.extra_data).forEach(key => extraDataKeys.add(key));
        }
    });
    
    const extraColumns = Array.from(extraDataKeys).sort();
    
    // Build headers with extra columns
    const headers = [
        'ID', 'Status', 'Created At', 'Completed At', 
        'Filename', 'Quantity', 'Groups', 'Filament Used', 
        'Ejection', 'Duration', 'Source',
        ...extraColumns
    ];
    
    // Build rows with extra data
    const rows = filteredHistory.map(item => {
        const baseRow = [
            item.id,
            item.is_active ? item.status : 'completed',
            formatDate(item.created_at),
            item.completed_at ? formatDate(item.completed_at) : (item.is_active ? 'In Progress' : 'N/A'),
            item.filename,
            item.is_active ? `${item.sent || 0}/${item.quantity}` : `${item.quantity}/${item.quantity}`,
            item.groups.join('; '),
            formatFilament(item.filament_g * (item.sent || item.quantity)),
            item.ejection_enabled ? 'Enabled' : 'Disabled',
            item.duration_seconds ? formatDuration(item.duration_seconds) : (item.is_active ? 'Ongoing' : 'N/A'),
            item.source || 'Unknown'
        ];
        
        // Add extra data values in the same order as headers
        extraColumns.forEach(key => {
            const value = item.extra_data && item.extra_data[key] ? item.extra_data[key] : '';
            baseRow.push(value);
        });
        
        return baseRow;
    });
    
    // Generate CSV content with proper escaping
    const csvContent = [
        headers.map(h => `"${h.replace(/"/g, '""')}"`).join(','),
        ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
    ].join('\n');
    
    // Add timestamp to filename
    const timestamp = new Date().toISOString().slice(0, 10);
    downloadFile(csvContent, `print_history_${timestamp}.csv`, 'text/csv');
}

// Export to JSON
function exportToJSON() {
    const json = JSON.stringify(filteredHistory, null, 2);
    downloadFile(json, 'print_history.json', 'application/json');
}

// Download file helper
function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Utility functions
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString();
}

function formatFilament(grams) {
    if (grams >= 1000) {
        return (grams / 1000).toFixed(2) + 'kg';
    }
    return grams.toFixed(1) + 'g';
}

function formatDuration(seconds) {
    if (seconds === null) return 'N/A';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    
    if (hours > 0) {
        return `${hours}h ${minutes}m`;
    }
    return `${minutes}m`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function populateGroupFilter(groups) {
    const groupFilter = document.getElementById('group-filter');
    groupFilter.innerHTML = '<option value="all">All Groups</option>';
    groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        option.textContent = group;
        groupFilter.appendChild(option);
    });
}

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    if (refreshTimer) {
        clearInterval(refreshTimer);
    }
});
</script>
{% endblock %}