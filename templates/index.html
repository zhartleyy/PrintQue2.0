{% extends "base.html" %}

{% block title %}PrintQue Dashboard{% endblock %}

{% block extra_styles %}
<style>
    /* Page-specific styles for dashboard with dark mode support */
    .printer-card {
        background: var(--card-bg, #f8f9fa);
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: background-color 0.3s ease;
    }
    
    [data-theme="dark"] .printer-card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .printer-header {
        border-bottom: 1px solid var(--border-color, #ddd);
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    
    .printer-header h3 {
        margin: 0 0 5px 0;
        font-size: 18px;
        color: var(--text-primary, #333);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .printer-header p {
        margin: 0;
        color: var(--text-secondary, #666);
        font-size: 14px;
    }
    
    .printer-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 5px;
    }
    
    .printer-group button {
        background: none;
        border: none;
        color: #007bff;
        cursor: pointer;
        padding: 0;
        font-size: 14px;
    }
    
    [data-theme="dark"] .printer-group button {
        color: #4dabf7;
    }
    
    .printer-group button:hover {
        text-decoration: underline;
    }
    
    .edit-form {
        margin-top: 10px;
        /* Ensure labels/inputs align properly */
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 5px;
    }
    
    .edit-form .form-label {
        /* Reset styles for inline labels */
        margin-bottom: 0;
        font-weight: normal;
    }

    .edit-form input {
        width: 100%; /* Make input fill its constrained label/span width */
        display: block; /* Make input take full width of its container */
        margin-right: 0 !important; /* Remove original inline margin */
    }
    
    /* Re-apply width constraints to the label/container instead of the input directly */
    .edit-form .form-control-container {
        width: 150px;
        display: inline-block;
        margin-right: 10px;
    }
    
    .edit-form button {
        font-size: 12px;
        padding: 5px 10px;
        /* Adjust alignment for buttons */
        margin-top: 14px; 
        height: 30px;
    }
    
    /* Minor style adjustment for the original Jinja version for consistency */
    .edit-form .form-control {
        height: 30px;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .printer-info {
        display: flex;
        gap: 30px;
        margin-bottom: 15px;
    }
    
    .printer-info h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: var(--text-primary, #333);
    }
    
    .printer-info p {
        margin: 0;
        font-size: 14px;
        color: var(--text-secondary, #666);
    }
    
    .print-progress h4,
    .print-completed h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: var(--text-primary, #333);
    }
    
    .print-progress p,
    .print-completed p {
        margin: 0 0 5px 0;
        font-size: 14px;
        color: var(--text-secondary, #666);
    }
    
    .progress {
        height: 20px;
        border-radius: 10px;
        margin-bottom: 10px;
    }
    
    [data-theme="dark"] .progress {
        background-color: var(--bg-secondary, #2d2d2d);
    }
    
    .order-table {
        margin-top: 15px;
    }
    
    [data-theme="dark"] .table {
        color: var(--text-primary);
    }
    
    [data-theme="dark"] .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(255, 255, 255, 0.03);
    }
    
    [data-theme="dark"] .table-striped tbody tr:nth-of-type(odd) > * {
        color: var(--text-primary);
    }
    
    [data-theme="dark"] .table tbody tr > * {
        color: var(--text-primary);
    }
    
    .order-controls {
        display: flex;
        gap: 5px;
    }
    
    .checkbox-dropdown-menu {
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
    }
    
    [data-theme="dark"] .dropdown-menu {
        background-color: var(--bg-secondary, #2d2d2d);
        border-color: var(--border-color, #404040);
    }
    
    [data-theme="dark"] .dropdown-item {
        color: var(--text-primary);
    }
    
    [data-theme="dark"] .dropdown-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .stats-grid {
        display: flex;
        gap: 20px;
        margin-bottom: 0;
        justify-content: space-between;
        flex-wrap: wrap;
    }
    
    @media (max-width: 1200px) {
        .stats-grid {
            gap: 15px;
        }
        
        .stat-item {
            min-width: 120px;
        }
    }
    
    @media (max-width: 768px) {
        .stats-grid {
            gap: 10px;
        }
        
        .stat-item {
            min-width: 100px;
            padding: 15px 10px;
        }
        
        .stat-value {
            font-size: 24px !important;
        }
    }
    
    @media (max-width: 480px) {
        .stats-grid {
            gap: 8px;
        }
        
        .stat-item {
            min-width: 80px;
            padding: 10px 5px;
        }
        
        .stat-icon {
            font-size: 18px !important;
        }
        
        .stat-value {
            font-size: 20px !important;
        }
        
        .stat-label {
            font-size: 11px !important;
        }
    }
    
    .stat-item {
        background: var(--bg-secondary, #f8f9fa);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        border: 1px solid var(--border-color, #e9ecef);
        position: relative;
        overflow: hidden;
        flex: 1;
        min-width: 140px;
    }
    
    [data-theme="dark"] .stat-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .stat-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    [data-theme="dark"] .stat-item:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .stat-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: currentColor;
        opacity: 0.8;
    }
    
    .stat-item.stat-ready::before { background-color: #28a745; }
    .stat-item.stat-printing::before { background-color: #007bff; }
    .stat-item.stat-finished::before { background-color: #ff8c00; }
    .stat-item.stat-stopped::before { background-color: #dc3545; }
    .stat-item.stat-offline::before { background-color: #dc3545; }
    .stat-item.stat-total::before { background-color: #17a2b8; }
    
    .stat-icon {
        font-size: 24px;
        margin-bottom: 10px;
        opacity: 0.8;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 5px;
        line-height: 1;
        white-space: nowrap;
    }
    
    .stat-label {
        font-size: 13px;
        color: var(--text-secondary, #666);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 50%, #6366f1 100%);
        color: white;
        border-radius: 16px;
        padding: 35px 40px;
        margin-bottom: 25px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(59, 130, 246, 0.15);
        backdrop-filter: blur(10px);
    }
    
    [data-theme="dark"] .dashboard-header {
        background: linear-gradient(135deg, #0284c7 0%, #2563eb 50%, #4f46e5 100%);
        box-shadow: 0 8px 32px rgba(37, 99, 235, 0.25);
    }
    
    .dashboard-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(255,255,255,0.05) 0%, transparent 50%),
                    radial-gradient(circle at 40% 40%, rgba(255,255,255,0.03) 0%, transparent 50%);
        pointer-events: none;
    }
    
    .dashboard-header::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 80%;
        height: 200%;
        background: linear-gradient(45deg, transparent 0%, rgba(255,255,255,0.04) 50%, transparent 100%);
        transform: rotate(15deg);
        pointer-events: none;
    }
    
    .dashboard-header h5 {
        margin: 0 0 8px 0;
        font-size: 28px;
        font-weight: 700;
        position: relative;
        z-index: 1;
        letter-spacing: -0.02em;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .dashboard-subtitle {
        margin: 0;
        opacity: 0.9;
        font-size: 16px;
        position: relative;
        z-index: 1;
        font-weight: 400;
        letter-spacing: 0.01em;
    }
    
    .printer-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }
    
    .compact-view .printer-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
    
    /* Enhanced compact view styles */
    .compact-view .printer-card {
        padding: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .compact-view .printer-card:hover {
        border-color: var(--border-color, #ddd);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    [data-theme="dark"] .compact-view .printer-card:hover {
        border-color: var(--border-color, #404040);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .compact-view .printer-card.expanded {
        border-color: #007bff;
        background-color: var(--card-bg-expanded, #f8f9fa);
        transform: scale(1.02);
        z-index: 10;
        position: relative;
    }
    
    [data-theme="dark"] .compact-view .printer-card.expanded {
        border-color: #4dabf7;
        background-color: var(--card-bg-expanded, rgba(255, 255, 255, 0.08));
    }
    
    .compact-view .printer-details {
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .compact-view .printer-card.expanded .printer-details {
        display: block;
        opacity: 1;
        margin-top: 15px;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Add a visual indicator that cards are clickable in compact view */
    .compact-view .printer-card::after {
        content: "Click to expand";
        position: absolute;
        bottom: 5px;
        right: 10px;
        font-size: 0.7rem;
        color: var(--text-secondary, #999);
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .compact-view .printer-card:hover::after {
        opacity: 1;
    }
    
    .compact-view .printer-card.expanded::after {
        content: "Click to collapse";
    }
    
    .btn-stopping {
        opacity: 0.7;
        pointer-events: none;
        position: relative;
        padding-right: 2.5rem;
    }
    
    .btn-stopping:after {
        content: "";
        position: absolute;
        width: 1rem;
        height: 1rem;
        right: 0.5rem;
        top: calc(50% - 0.5rem);
        border: 0.15rem solid rgba(255, 255, 255, 0.5);
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border 0.75s linear infinite;
    }
    
    @keyframes spinner-border {
        to { transform: rotate(360deg); }
    }
    
    .status-indicator {
        display: inline-block;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        margin-right: 12px;
        flex-shrink: 0;
    }
    
    .status-indicator.ready {
        background-color: #28a745;
    }
    
    .status-indicator.printing {
        background-color: #007bff;
    }
    
    .status-indicator.paused {
        background-color: #ffc107;
    }
    
    .status-indicator.finished {
        background-color: #ff8c00;
    }
    
    .status-indicator.offline {
        background-color: #dc3545;
    }
    
    .status-indicator.service {
        background-color: #6c757d;
    }
    
    .printer-type-badge {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 3px;
        background-color: #ffffff;
        color: #000000;
        border: 1px solid #000000;
        margin-left: 5px;
    }
    
    [data-theme="dark"] .printer-type-badge {
        background-color: #1a1a1a;
        color: #ffffff;
        border: 1px solid #ffffff;
    }
    
    .printer-title-wrapper {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .filename-note { 
        font-size: 0.85rem; 
        color: var(--text-secondary, #666);
        margin-top: 5px; 
    }
    
    /* Dark mode button adjustments */
    [data-theme="dark"] .btn-outline-secondary {
        color: var(--text-primary);
        border-color: var(--border-color);
    }
    
    [data-theme="dark"] .btn-outline-secondary:hover {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    /* Alert adjustments for dark mode */
    [data-theme="dark"] .alert-warning {
        background-color: #3d3200;
        border-color: #5c4e00;
        color: #ffc107;
    }
    
    [data-theme="dark"] .alert-info {
        background-color: #002752;
        border-color: #003d7a;
        color: #6cb2eb;
    }
    
    /* Form control adjustments */
    [data-theme="dark"] .form-control:focus,
    [data-theme="dark"] .form-select:focus {
        background-color: var(--bg-secondary);
        border-color: #0066cc;
        color: var(--text-primary);
        box-shadow: 0 0 0 0.25rem rgba(0, 102, 204, 0.25);
    }
    
    /* Code/filename styling in dark mode */
    [data-theme="dark"] code {
        background-color: rgba(255, 255, 255, 0.1);
        color: #e83e8c;
    }
    
    /* Quantity edit styles */
    .quantity-display {
        cursor: pointer;
        text-decoration: underline;
        text-decoration-style: dotted;
        text-underline-offset: 2px;
        /* Add a data attribute for easier retrieval in delegation */
        user-select: none;
    }
    
    .quantity-display:hover {
        text-decoration-style: solid;
    }
    
    .quantity-edit-form {
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    
    .quantity-edit-form input {
        width: 60px;
        padding: 2px 5px;
        font-size: 0.875rem;
        height: 28px;
    }
    
    .quantity-edit-form button {
        padding: 2px 8px;
        font-size: 0.75rem;
        height: 28px;
        line-height: 1;
    }

    /* Order movement animations and visual feedback */

    /* Moving state indicators */
    .order-moving-up {
        background: linear-gradient(90deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.2), rgba(40, 167, 69, 0.1)) !important;
        border-left: 3px solid #28a745;
        transform: translateY(-2px);
        transition: all 0.3s ease;
    }

    /* Moving state indicators */
    .order-moving-up {
        background: linear-gradient(90deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.2), rgba(40, 167, 69, 0.1)) !important;
        border-left: 3px solid #28a745;
        transform: translateY(-2px);
        transition: all 0.3s ease;
    }

    .order-moving-down {
        background: linear-gradient(90deg, rgba(0, 123, 255, 0.1), rgba(0, 123, 255, 0.2), rgba(0, 123, 255, 0.1)) !important;
        border-left: 3px solid #007bff;
        transform: translateY(2px);
        transition: all 0.3s ease;
    }

    /* Highlight effect after successful move */
    .order-moved-highlight {
        background: linear-gradient(90deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.3), rgba(255, 193, 7, 0.1)) !important;
        border-left: 3px solid #ffc107;
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        transition: all 0.4s ease;
    }

    /* Sliding animations for reordered rows */
    .order-slide-up {
        animation: slideFromBelow 0.6s ease-out;
    }

    .order-slide-down {
        animation: slideFromAbove 0.6s ease-out;
    }

    @keyframes slideFromBelow {
        0% {
            transform: translateY(50px);
            opacity: 0.7;
            background: rgba(40, 167, 69, 0.15);
        }
        50% {
            background: rgba(40, 167, 69, 0.1);
        }
        100% {
            transform: translateY(0);
            opacity: 1;
            background: transparent;
        }
    }

    @keyframes slideFromAbove {
        0% {
            transform: translateY(-50px);
            opacity: 0.7;
            background: rgba(0, 123, 255, 0.15);
        }
        50% {
            background: rgba(0, 123, 255, 0.1);
        }
        100% {
            transform: translateY(0);
            opacity: 1;
            background: transparent;
        }
    }

    /* Move indicator popup */
    .order-move-indicator {
        background: rgba(33, 37, 41, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        opacity: 0;
        transform: translateX(20px) scale(0.8);
        transition: all 0.3s ease;
        pointer-events: none;
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] .order-move-indicator {
        background: rgba(248, 249, 250, 0.9);
        color: #212529;
    }

    .order-move-indicator.up {
        border-left: 4px solid #28a745;
    }

    .order-move-indicator.down {
        border-left: 4px solid #007bff;
    }

    .order-move-indicator.show {
        opacity: 1;
        transform: translateX(0) scale(1);
    }

    /* Enhanced order controls with better disabled state */
    .order-controls button:disabled {
        transition: opacity 0.3s ease;
        cursor: not-allowed;
    }

    .order-controls button:not(:disabled) {
        transition: all 0.2s ease;
    }

    .order-controls button:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Pulse effect for active operations */
    .order-controls button:disabled {
        animation: pulse-subtle 1.5s ease-in-out infinite;
    }

    @keyframes pulse-subtle {
        0%, 100% {
            opacity: 0.5;
        }
        50% {
            opacity: 0.7;
        }
    }

    /* Row hover enhancements */
    .order-table tbody tr {
        transition: all 0.2s ease;
    }

    .order-table tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.04) !important;
        transform: translateX(2px);
    }

    [data-theme="dark"] .order-table tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.03) !important;
    }

    /* Improved visual feedback for successful operations */
    .order-success-flash {
        animation: successFlash 1s ease-out;
    }

    @keyframes successFlash {
        0% {
            background: rgba(40, 167, 69, 0.3);
            transform: scale(1.02);
        }
        50% {
            background: rgba(40, 167, 69, 0.1);
        }
        100% {
            background: transparent;
            transform: scale(1);
        }
    }

    /* Larger ejection toggle switch */
    #ejectionToggle {
        width: 3rem !important;
        height: 1.5rem !important;
        border-radius: 1rem !important;
    }

    #ejectionToggle:checked {
        background-color: #198754 !important;
        border-color: #198754 !important;
    }

    #ejectionToggle:not(:checked) {
        background-color: #ffc107 !important;
        border-color: #ffc107 !important;
    }

    #ejectionToggle::before {
        width: 1.25rem !important;
        height: 1.25rem !important;
        border-radius: 50% !important;
        margin-left: 0.125rem !important;
        margin-top: 0.125rem !important;
    }

    #ejectionToggle:checked::before {
        transform: translateX(1.5rem) !important;
    }

    .ejection-control-wrapper {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-color, #dee2e6);
        border-radius: 0.375rem;
        background: var(--bg-secondary, #f8f9fa);
    }

    [data-theme="dark"] .ejection-control-wrapper {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--border-color, #404040);
    }

    .ejection-label {
        font-weight: 500;
        font-size: 0.875rem;
        margin: 0;
        white-space: nowrap;
    }

    /* NEW: Timer styles for finished printers */
    .finished-time-bottom {
        background: #ff8c00;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
        margin-left: auto;
        vertical-align: middle;
    }
    .printer-bottom-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
    }
    
    /* NEW: Additional styles for the enhanced ejection interface */
    #endGcodeSection {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        background-color: #f8f9fa;
    }

    [data-theme="dark"] #endGcodeSection {
        border-color: var(--border-color, #404040);
        background-color: rgba(255, 255, 255, 0.03);
    }

    #endGcodeInput {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.4;
        resize: vertical;
        min-height: 120px;
        transition: all 0.2s ease;
    }
    
    [data-theme="dark"] #endGcodeInput {
        background-color: var(--bg-secondary);
    }

    #uploadEjectionBtn {
        transition: all 0.2s ease;
    }

    #uploadEjectionBtn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .alert {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: none;
    }

    /* Drag and drop visual feedback */
    #endGcodeInput.dragover {
        background-color: #e3f2fd !important;
        border: 2px dashed #2196f3 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4" style="margin-top: 100px;">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alert-container mb-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        <strong>{{ category|title }}:</strong> {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    <div class="card mb-4" style="border: none; box-shadow: 0 8px 32px rgba(0,0,0,0.08); border-radius: 24px;">
        <div class="card-body" style="padding: 0;">
            <div class="dashboard-header">
                <h5 class="card-title">Print Farm Status</h5>
                <p class="dashboard-subtitle">Real-time overview of your 3D printing operations</p>
            </div>
            <div style="padding: 30px 40px 35px 40px;">
                <div class="stats-grid">
                    <div class="stat-item stat-ready">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value text-success">{{ printers|selectattr('state', 'in', ['IDLE', 'READY'])|list|length }}</div>
                        <div class="stat-label">Ready</div>
                    </div>
                    <div class="stat-item stat-printing">
                        <div class="stat-icon">üñ®Ô∏è</div>
                        <div class="stat-value text-primary">{{ printers|selectattr('state', 'equalto', 'PRINTING')|list|length }}</div>
                        <div class="stat-label">Printing</div>
                    </div>
                    <div class="stat-item stat-finished">
                        <div class="stat-icon">‚ú®</div>
                        <div class="stat-value" style="color: #ff8c00;">{{ printers|selectattr('state', 'equalto', 'FINISHED')|list|length }}</div>
                        <div class="stat-label">Finished</div>
                    </div>
                    <div class="stat-item stat-stopped">
                        <div class="stat-icon">‚ö†Ô∏è</div>
                        <div class="stat-value text-danger">{{ printers|selectattr('state', 'in', ['STOPPED', 'ATTENTION', 'ERROR'])|list|length }}</div>
                        <div class="stat-label">Stopped</div>
                    </div>
                    <div class="stat-item stat-offline">
                        <div class="stat-icon">üîå</div>
                        <div class="stat-value text-danger">{{ printers|selectattr('state', 'equalto', 'OFFLINE')|list|length }}</div>
                        <div class="stat-label">Offline</div>
                    </div>
                    <div class="stat-item stat-total">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value text-info">{{ printers|length }}</div>
                        <div class="stat-label">Total Printers</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">New Orders</h5>
            <form method="post" enctype="multipart/form-data" action="/start_print">
                <div class="mb-3">
                    <label class="form-label">Select G-code File</label>
                    <input class="form-control" type="file" name="gcode_file" accept=".gcode,.bgcode,.3mf" required>
                    <div class="filename-note">
                        Accepted formats: .gcode, .bgcode, .3mf
                        <br>
                        <span class="text-muted">Note: Files will be automatically uploaded to Bambu printers</span>
                    </div>
                </div>
                {% if printers|selectattr('type', 'equalto', 'bambu')|list|length > 0 %}
                <div id="bambuUploadProgress" class="alert alert-info mb-3" style="display: none;">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Uploading...</span>
                        </div>
                        <span>Uploading file to Bambu printer...</span>
                    </div>
                </div>
                {% endif %}
                <div class="mb-3">
                    <label class="form-label">Quantity</label>
                    <input type="number" class="form-control" name="quantity" min="1" value="1" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Select Printer Groups</label>
                    <div class="d-flex align-items-center">
                        <div class="dropdown me-3">
                            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                Select Groups
                            </button>
                            <div class="dropdown-menu checkbox-dropdown-menu">
                                {% for group in printers|map(attribute='group')|map('string')|unique|sort %}
                                <div class="form-check">
                                    <input class="form-check-input group-checkbox" type="checkbox" name="groups" value="{{ group }}" id="group_{{ group }}">
                                    <label class="form-check-label" for="group_{{ group }}">{{ group }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableEjection" name="ejection_enabled" 
                                   onchange="toggleEndGcodeSection()">
                            <label class="form-check-label" for="enableEjection">Enable Ejection</label>
                        </div>
                    </div>
                    <div class="form-text">Select multiple groups to send the order to all ready printers in those groups.</div>
                </div>
                
                <div class="mb-3" id="endGcodeSection" style="display: none;">
                    <label class="form-label">Custom End G-code</label>
                    
                    <div class="mb-2 d-flex align-items-center">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="uploadEjectionBtn" onclick="uploadEjectionFile()">
                            <i class="fas fa-file-upload me-1"></i>Upload G-code File
                        </button>
                        <input type="file" id="ejectionFileInput" style="display: none;" accept=".txt,.gcode,.gc,.nc" onchange="handleEjectionFileUpload(this)">
                        <small class="text-muted ms-2" id="uploadedFileName" style="display: none;"></small>
                    </div>
                    
                    <textarea class="form-control" name="end_gcode" id="endGcodeInput" rows="6">{{ default_end_gcode }}</textarea>
                    
                    <div class="form-text">
                        This G-code will run after the print if ejection is enabled, then reset to Ready. 
                        You can type directly or **drag and drop** a file (.txt, .gcode, .gc, .nc) onto the textarea.
                    </div>
                    
                    <div class="d-flex gap-2 mt-2">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="saveDefaultEndGcode()">
                            Save as Default
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearEjectionGcode()">
                            Clear
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Send Order</button>
            </form>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Active Orders</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="privacyModeToggle" onchange="togglePrivacyMode()">
                    <label class="form-check-label" for="privacyModeToggle">Privacy Mode</label>
                </div>
            </div>
            <div class="table-responsive order-table">
                <table id="ordersTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Job Name</th>
                            <th>Quantity</th>
                            <th>Groups</th>
                            <th>Status</th>
                            <th>Ejection</th>
                            <th>Controls</th>
                        </tr>
                    </thead>
                    <tbody id="orderList">
                        {% for order in orders %}
                        <tr data-order-id="{{ order.id }}">
                            <td>{{ order.id }}</td>
                            <td>
                                <span class="job-name" data-original="{{ order.filename }}">
                                    {{ order.filename }}
                                </span>
                            </td>
                            <td>
                                <span class="quantity-display {{ 'text-success' if order.sent >= order.quantity else '' }}" 
                                      data-order-id="{{ order.id }}"
                                      data-order-sent="{{ order.sent }}"
                                      data-order-quantity="{{ order.quantity }}"
                                      title="Click to edit quantity">
                                    {{ order.sent }}/{{ order.quantity }}
                                    {% if order.sent >= order.quantity %}
                                        <span class="badge bg-success ms-1">‚úì</span>
                                    {% endif %}
                                </span>
                                <div id="quantity-edit-{{ order.id }}" class="quantity-edit-form" style="display: none;">
                                    <span>{{ order.sent }}/</span>
                                    <input type="number" id="quantity-input-{{ order.id }}" 
                                           value="{{ order.quantity }}" 
                                           min="{{ order.sent }}" 
                                           class="form-control form-control-sm">
                                    <button class="btn btn-success btn-sm" onclick="saveQuantity('{{ order.id }}', {{ order.sent }})">‚úì</button>
                                    <button class="btn btn-secondary btn-sm" onclick="cancelEditQuantity('{{ order.id }}')">‚úó</button>
                                </div>
                            </td>
                            <td>{{ order.groups|join(', ') }}</td>
                            <td>
                                {% if order.status == 'fulfilled' %}
                                    <span class="badge bg-success">Fulfilled</span>
                                {% elif order.status == 'partial' %}
                                    <span class="badge bg-warning">In Progress</span>
                                {% elif order.status == 'printing' %}
                                    <span class="badge bg-primary">Printing</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ order.status|capitalize }}</span>
                                {% endif %}
                            </td>
                            <td>{{ 'Enabled' if order.ejection_enabled else 'Disabled' }}</td>
                            <td>
                                <div class="order-controls">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="moveOrderUp('{{ order.id }}')">‚Üë</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="moveOrderDown('{{ order.id }}')">‚Üì</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteOrder('{{ order.id }}')">Delete</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Reset Printers by Group</h5>
            <p class="card-text">Mark all finished printers in a specific group as ready to gradually restart your print farm and avoid power spikes.</p>
            <div class="d-flex flex-wrap gap-2 align-items-center">
                {% set unique_groups = printers|map(attribute='group')|unique|natural_sort %}
                {% for group in unique_groups %}
                    <form method="post" action="/mark_group_ready/{{ group }}" style="display:inline;" 
                          onsubmit="return confirm('Mark all FINISHED printers in {{ group }} as Ready?');">
                        <button type="submit" class="btn btn-outline-success">
                            Mark {{ group }} Ready
                            <span class="badge bg-secondary ms-1">
                                {{ printers|selectattr('group', 'equalto', group)|selectattr('state', 'equalto', 'FINISHED')|list|length }}
                            </span>
                        </button>
                    </form>
                {% endfor %}
                <form method="post" action="/mark_all_ready" onsubmit="return confirm('Are you sure you want to mark all Finished printers as Ready?');" style="display:inline;" class="ms-auto">
                    <button type="submit" class="btn btn-success">Mark All Finished as Ready</button>
                </form>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Bulk Actions</h5>
            <div class="d-flex flex-wrap gap-2 align-items-center">
                <form method="post" action="/stop_all_printers" onsubmit="return confirm('Are you sure you want to stop all active prints?');" style="display:inline;">
                    <button type="submit" class="btn btn-warning">Stop All Printers</button>
                </form>
                <form method="post" action="/delete_all_printers" onsubmit="return confirm('Are you sure you want to delete all printers?');" style="display:inline;">
                    <button type="submit" class="btn btn-danger">Delete All Printers</button>
                </form>
                <div class="ejection-control-wrapper ms-auto">
                    <span class="ejection-label">Ejection:</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="ejectionToggle" onchange="toggleEjection()">
                        <label class="form-check-label ejection-label" for="ejectionToggle">
                            <span id="ejectionStatusText">Active</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Printers</h5>
        <div class="d-flex align-items-center gap-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="compactViewToggle" onchange="toggleCompactView()">
                <label class="form-check-label" for="compactViewToggle">Compact View</label>
            </div>
            <select id="printerSort" class="form-select form-select-sm" style="width: auto;" onchange="sortPrinters()">
                <option value="name-asc">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
                <option value="group-asc">Group (Low to High)</option>
                <option value="group-desc">Group (High to Low)</option>
                <option value="type-prusa">Type: Prusa First</option>
                <option value="type-bambu">Type: Bambu First</option>
                <option value="status-ready">Status: Ready</option>
                <option value="status-printing">Status: Printing</option>
                <option value="status-finished">Status: Finished</option>
                <option value="status-offline">Status: Offline</option>
                <option value="status-service">Status: In Service</option>
            </select>
        </div>
    </div>

    <div id="printersContainer" class="printer-grid">
        {% for printer in printers %}
        <div class="printer-card" data-name="{{ printer.name }}" data-group="{{ printer.group }}" data-type="{{ printer.type }}" data-printer-name="{{ printer.name }}">
            <div class="printer-header">
                <h3 class="mb-0">
                    <div class="printer-title-wrapper">
                        <span class="status-indicator {% if printer.state in ['IDLE', 'READY'] %}ready{% elif printer.state == 'PRINTING' %}printing{% elif printer.state == 'PAUSED' %}paused{% elif printer.state == 'FINISHED' %}finished{% elif printer.state == 'SERVICE' %}service{% else %}offline{% endif %}"></span>
                        {{ printer.name }}
                    </div>
                    {% if printer.type == 'bambu' %}
                        <span class="printer-type-badge bambu">BAMBU</span>
                    {% elif printer.type == 'prusa' %}
                        <span class="printer-type-badge prusa">PRUSA</span>
                    {% endif %}
                </h3>
                <p class="printer-state">Status: {{ printer.status }}</p>
                <div class="printer-group">
                    <span>{{ printer.group }}</span>
                    <button onclick="showGroupEdit('{{ printer.name }}')">‚úèÔ∏è Edit</button>
                </div>
                <form class="edit-form" id="groupForm-{{ printer.name }}" method="post" action="/update_printer" style="display: none;">
                    <input type="hidden" name="printer_name" value="{{ printer.name }}">
                    
                    <label class="form-label d-inline-block" style="width: 150px; margin-right: 10px; font-size: 14px;">
                        Name
                        <input type="text" name="new_name" value="{{ printer.name }}" placeholder="Printer name" class="form-control form-control-sm" required>
                    </label>
                    
                    <label class="form-label d-inline-block" style="width: 150px; margin-right: 10px; font-size: 14px;">
                        Group
                        <input type="text" name="new_group" value="{{ printer.group }}" placeholder="Group name" class="form-control form-control-sm" maxlength="50" pattern="[\w\s-]+" title="Only letters, numbers, spaces, hyphens and underscores allowed" required>
                    </label>

                    <button type="submit" class="btn btn-primary btn-sm">Save</button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="hideGroupEdit('{{ printer.name }}')">Cancel</button>
                </form>
                {% if printer.state == 'OFFLINE' %}
                    <p class="text-danger mt-2">Debug: State is 'OFFLINE' - Check IP and API Key</p>
                {% endif %}
            </div>

            <div class="printer-details">
                <div class="printer-info">
                    <div>
                        <h4>Temperatures</h4>
                        <p>Nozzle: {{ printer.temps.nozzle|round(1) }}¬∞C</p>
                        <p>Bed: {{ printer.temps.bed|round(1) }}¬∞C</p>
                    </div>
                </div>

                {% if printer.state in ['PRINTING', 'PAUSED'] %}
                    <div class="print-progress">
                        <h4>Print Progress</h4>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ printer.progress|round(1) }}%">{{ printer.progress|round(1) }}%</div>
                        </div>
                        <p>File: <span class="job-name" data-original="{{ printer.file }}">{{ printer.file }}</span></p>
                        <p>Time Remaining: {{ (printer.time_remaining // 60) }} minutes</p>
                        <form method="post" action="/stop_print_by_name" onsubmit="return handleStopSubmit(event, '{{ printer.name }}');" style="display:inline;">
                            <input type="hidden" name="printer_name" value="{{ printer.name }}">
                            <button type="submit" class="btn btn-danger btn-sm">Stop</button>
                        </form>
                        {% if printer.state == 'PAUSED' %}
                            <form method="post" action="/resume_print_by_name" style="display:inline;">
                                <input type="hidden" name="printer_name" value="{{ printer.name }}">
                                <button type="submit" class="btn btn-success btn-sm">Resume</button>
                            </form>
                        {% endif %}
                    </div>
                {% elif printer.state == 'FINISHED' %}
                    <div class="print-completed">
                        <h4>Print Completed</h4>
                        <p>File: <span class="job-name" data-original="{{ printer.file }}">{{ printer.file }}</span></p>
                        <form method="post" action="/mark_ready_by_name">
                            <input type="hidden" name="printer_name" value="{{ printer.name }}">
                            <button type="submit" class="btn btn-success btn-sm">Mark as Ready</button>
                        </form>
                    </div>
                {% endif %}

                {% if printer.state not in ['PRINTING', 'PAUSED'] %}
                    <div class="printer-bottom-controls">
                        <form method="post" action="/delete_printer_by_name" onsubmit="return confirm('Are you sure you want to remove {{ printer.name }}?');" style="display:inline;">
                            <input type="hidden" name="printer_name" value="{{ printer.name }}">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                        {% if printer.state == 'FINISHED' and printer.minutes_since_finished is defined and printer.minutes_since_finished is not none %}
                            <div class="finished-time-bottom">{{ printer.minutes_since_finished }} min</div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
<script>
    // Global variables
    window.socket = io();
    window.compactView = false;
    window.privacyMode = false;

    // Global variable to track printer finish times
    window.printerFinishTimes = {};

    // Function to update all timer displays
    function updatePrinterTimers() {
        document.querySelectorAll('.printer-card').forEach(card => {
            const printerName = card.dataset.printerName;
            
            if (printerName && window.printerFinishTimes[printerName]) {
                const finishTime = window.printerFinishTimes[printerName];
                const currentTime = Date.now();
                const elapsedMinutes = Math.floor((currentTime - finishTime) / 60000);
                
                // Update the bottom timer display
                const bottomTimer = card.querySelector('.finished-time-bottom');
                if (bottomTimer) {
                    bottomTimer.textContent = `${elapsedMinutes} min`;
                }
            }
        });
    }

    // New function to update the printers' HTML display
    function updatePrintersDisplay(data) {
        const container = document.getElementById('printersContainer');
        if (!container) return;
        
        const openForms = [];
        const expandedCards = [];
        const currentInputValues = new Map();

        document.querySelectorAll('[id^="groupForm-"]').forEach(form => {
            if (form.style.display !== 'none') {
                const printerName = form.id.replace('groupForm-', '');
                openForms.push(printerName);
                
                const nameInput = form.querySelector('input[name="new_name"]');
                const groupInput = form.querySelector('input[name="new_group"]');
                if (nameInput && groupInput) {
                    currentInputValues.set(printerName, {
                        name: nameInput.value,
                        group: groupInput.value
                    });
                }
            }
        });

        document.querySelectorAll('.printer-card.expanded').forEach(card => {
            expandedCards.push(card.dataset.name);
        });
        
        const printers = [...data.printers].sort((a, b) => naturalSort(a.name, b.name));
        container.innerHTML = printers.map((p) => `
            <div class="printer-card" data-name="${p.name}" data-group="${p.group}" data-type="${p.type || 'prusa'}" data-printer-name="${p.name}">
                <div class="printer-header">
                    <h3 class="mb-0">
                        <div class="printer-title-wrapper">
                            <span class="status-indicator ${p.state === 'IDLE' || p.state === 'READY' ? 'ready' : p.state === 'PRINTING' ? 'printing' : p.state === 'PAUSED' ? 'paused' : p.state === 'FINISHED' ? 'finished' : p.state === 'SERVICE' ? 'service' : 'offline'}"></span>
                            ${p.name}
                        </div>
                        ${p.type === 'bambu' ? '<span class="printer-type-badge bambu">BAMBU</span>' : 
                          p.type === 'prusa' ? '<span class="printer-type-badge prusa">PRUSA</span>' : ''}
                    </h3>
                    <p class="printer-state">Status: ${p.status}</p>
                    <div class="printer-group">
                        <span>${p.group}</span>
                        <button onclick="showGroupEdit('${p.name}')">‚úèÔ∏è Edit</button>
                    </div>
                    <form class="edit-form" id="groupForm-${p.name}" method="post" action="/update_printer" style="display: none;">
                        <input type="hidden" name="printer_name" value="${p.name}">
                        
                        <label class="form-label d-inline-block" style="width: 150px; margin-right: 10px; font-size: 14px;">
                            Name
                            <input type="text" name="new_name" value="${p.name}" placeholder="Printer name" class="form-control form-control-sm" required>
                        </label>
                        
                        <label class="form-label d-inline-block" style="width: 150px; margin-right: 10px; font-size: 14px;">
                            Group
                            <input type="text" name="new_group" value="${p.group}" placeholder="Group name" class="form-control form-control-sm" maxlength="50" pattern="[\\w\\s-]+" title="Only letters, numbers, spaces, hyphens and underscores allowed" required>
                        </label>

                        <button type="submit" class="btn btn-primary btn-sm">Save</button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="hideGroupEdit('${p.name}')">Cancel</button>
                    </form>
                    ${p.state === 'OFFLINE' ? '<p class="text-danger mt-2">Debug: State is \'OFFLINE\' - Check IP and API Key</p>' : ''}
                </div>
                <div class="printer-details">
                    <div class="printer-info">
                        <div>
                            <h4>Temperatures</h4>
                            <p>Nozzle: ${p.temps.nozzle.toFixed(1)}¬∞C</p>
                            <p>Bed: ${p.temps.bed.toFixed(1)}¬∞C</p>
                        </div>
                    </div>
                    ${p.state === 'PRINTING' || p.state === 'PAUSED' ? `
                        <div class="print-progress">
                            <h4>Print Progress</h4>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-success" role="progressbar" style="width: ${p.progress.toFixed(1)}%">${p.progress.toFixed(1)}%</div>
                            </div>
                            <p>File: <span class="job-name" data-original="${p.file}">${window.maskJobName(p.file)}</span></p>
                            <p>Time Remaining: ${Math.floor(p.time_remaining / 60)} minutes</p>
                            <form method="post" action="/stop_print_by_name" onsubmit="return handleStopSubmit(event, '${p.name}');" style="display:inline;">
                                <input type="hidden" name="printer_name" value="${p.name}">
                                <button type="submit" class="btn btn-danger btn-sm">Stop</button>
                            </form>
                            ${p.state === 'PAUSED' ? `<form method="post" action="/resume_print_by_name" style="display:inline;"><input type="hidden" name="printer_name" value="${p.name}"><button type="submit" class="btn btn-success btn-sm">Resume</button></form>` : ''}
                        </div>
                    ` : p.state === 'FINISHED' ? `
                        <div class="print-completed">
                            <h4>Print Completed</h4>
                            <p>File: <span class="job-name" data-original="${p.file}">${window.maskJobName(p.file)}</span></p>
                            <form method="post" action="/mark_ready_by_name">
                                <input type="hidden" name="printer_name" value="${p.name}">
                                <button type="submit" class="btn btn-success btn-sm">Mark as Ready</button>
                            </form>
                        </div>
                    ` : ''}
                    ${p.state !== 'PRINTING' && p.state !== 'PAUSED' ? `
                        <div class="printer-bottom-controls">
                            <form method="post" action="/delete_printer_by_name" onsubmit="return confirm('Are you sure you want to remove ${p.name}?');" style="display:inline;">
                                <input type="hidden" name="printer_name" value="${p.name}">
                                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                            </form>
                            ${p.state === 'FINISHED' && p.minutes_since_finished !== undefined && p.minutes_since_finished !== null ? 
                                `<div class="finished-time-bottom">${p.minutes_since_finished} min</div>` : ''}
                        </div>
                    ` : ''}
                </div>
            </div>
        `).join('');
        
        openForms.forEach(printerName => {
            window.showGroupEdit(printerName);
            if (currentInputValues.has(printerName)) {
                const values = currentInputValues.get(printerName);
                const form = document.getElementById(`groupForm-${printerName}`);
                if (form) {
                    const nameInput = form.querySelector('input[name="new_name"]');
                    const groupInput = form.querySelector('input[name="new_group"]');
                    if (nameInput && groupInput) {
                        nameInput.value = values.name;
                        groupInput.value = values.group;
                        if (document.activeElement === nameInput || document.activeElement === groupInput) {
                            const focusedInput = document.activeElement === nameInput ? nameInput : groupInput;
                            const cursorPosition = focusedInput.selectionStart;
                            setTimeout(() => {
                                focusedInput.focus();
                                focusedInput.setSelectionRange(cursorPosition, cursorPosition);
                            }, 0);
                        }
                    }
                }
            }
        });
        
        expandedCards.forEach(printerName => {
            const card = document.querySelector(`[data-name="${printerName}"]`);
            if (card) {
                card.classList.add('expanded');
            }
        });
        
        if (window.compactView) {
            document.body.classList.add('compact-view');
            addCompactViewClickHandlers();
        }
        
        applySavedSort();
    }
    
    // Override the global updatePrinters function
    window.updatePrinters = function(data) {
        // === START OF FIX: Skip update if user is actively editing printer/group name ===
        const activeElement = document.activeElement;
        if (activeElement && 
            (activeElement.name === 'new_name' || activeElement.name === 'new_group') &&
            activeElement.closest('.edit-form')) {
            // Skip update if user is actively editing printer settings
            console.log('Skipping update - user is editing printer settings');
            return;
        }
        // === END OF FIX ===
        
        // First, update finish times based on the data
        data.printers.forEach(printer => {
            if (printer.state === 'FINISHED') {
                // If we don't have a finish time stored, calculate it
                if (!window.printerFinishTimes[printer.name]) {
                    if (printer.minutes_since_finished !== undefined && printer.minutes_since_finished !== null) {
                        // Calculate the finish time based on server-provided minutes
                        const finishTime = Date.now() - (printer.minutes_since_finished * 60000);
                        window.printerFinishTimes[printer.name] = finishTime;
                        console.log(`Set finish time for ${printer.name}: ${printer.minutes_since_finished} minutes ago`);
                    } else {
                        // If no minutes provided, assume it just finished
                        window.printerFinishTimes[printer.name] = Date.now();
                        console.log(`Set finish time for ${printer.name}: just now`);
                    }
                }
            } else {
                // Clear finish time if printer is no longer in FINISHED state
                if (window.printerFinishTimes[printer.name]) {
                    console.log(`Clearing finish time for ${printer.name} - state is now ${printer.state}`);
                    delete window.printerFinishTimes[printer.name];
                }
            }
        });
        
        // Now update the display (this will rebuild the HTML)
        updatePrintersDisplay(data);
        
        // Update timers after display update
        updatePrinterTimers();
    };


    // Start the timer update interval
    setInterval(updatePrinterTimers, 1000);

    // Load finish times from localStorage on page load
    window.addEventListener('DOMContentLoaded', function() {
        const savedFinishTimes = localStorage.getItem('printerFinishTimes');
        if (savedFinishTimes) {
            try {
                window.printerFinishTimes = JSON.parse(savedFinishTimes);
                console.log('Loaded finish times from localStorage:', window.printerFinishTimes);
            } catch (e) {
                console.error('Error loading finish times:', e);
                window.printerFinishTimes = {};
            }
        }
        
        // Initial timer update
        updatePrinterTimers();
    });

    // Save finish times to localStorage whenever they change
    setInterval(function() {
        localStorage.setItem('printerFinishTimes', JSON.stringify(window.printerFinishTimes));
    }, 5000);
    
    // Make functions globally accessible
    window.maskJobName = function(name) {
        if (!window.privacyMode) return name;
        return name.replace(/[^.\s]/g, '*');
    }

    window.togglePrivacyMode = function() {
        window.privacyMode = document.getElementById('privacyModeToggle').checked;
        
        // Update all job names
        document.querySelectorAll('.job-name').forEach(el => {
            const original = el.getAttribute('data-original');
            el.textContent = window.maskJobName(original);
        });
    }

    window.toggleCompactView = function() {
        window.compactView = document.getElementById('compactViewToggle').checked;
        
        // Save compact view preference
        localStorage.setItem('compactView', window.compactView);
        
        if (window.compactView) {
            document.body.classList.add('compact-view');
            // Add click handlers for compact view
            addCompactViewClickHandlers();
        } else {
            document.body.classList.remove('compact-view');
            // Remove click handlers
            document.querySelectorAll('.printer-card').forEach(card => {
                const newCard = card.cloneNode(true);
                card.parentNode.replaceChild(newCard, card);
            });
        }
    }

    function addCompactViewClickHandlers() {
        document.querySelectorAll('.printer-card').forEach(card => {
            // Remove existing listeners by cloning
            const newCard = card.cloneNode(true);
            card.parentNode.replaceChild(newCard, card);
            
            // Add new listener
            newCard.addEventListener('click', function(e) {
                if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT' && !e.target.closest('form')) {
                    this.classList.toggle('expanded');
                }
            });
        });
    }

    // Socket event listener
    window.socket.on('status_update', (data) => {
        updatePrinters(data);
        updateOrders(data);
        updateStats(data);
        updateEjectionStatus();
    });
    
    // === Order Quantity Functions (Cleaned up and consolidated) ===

    window.editQuantity = function(orderId, sent, quantity) {
        console.log('editQuantity called:', orderId, sent, quantity);
        
        const displaySpan = document.querySelector(`span.quantity-display[data-order-id="${orderId}"]`);
        const editForm = document.getElementById(`quantity-edit-${orderId}`);
        
        if (displaySpan) displaySpan.style.display = 'none';
        if (editForm) {
            editForm.style.display = 'inline-flex';
            const input = document.getElementById(`quantity-input-${orderId}`);
            if (input) {
                input.focus();
                input.select();
            }
        } else {
            console.error('Could not find edit form for order:', orderId);
        }
    };

    window.cancelEditQuantity = function(orderId) {
        console.log('cancelEditQuantity called:', orderId);
        const displaySpan = document.querySelector(`span.quantity-display[data-order-id="${orderId}"]`);
        const editForm = document.getElementById(`quantity-edit-${orderId}`);
        
        if (displaySpan) displaySpan.style.display = 'inline';
        if (editForm) editForm.style.display = 'none';
    };

    window.saveQuantity = function(orderId, sent) {
        console.log('saveQuantity called:', orderId, sent);
        const input = document.getElementById(`quantity-input-${orderId}`);
        
        if (!input) {
            console.error('Could not find quantity input for order:', orderId);
            return;
        }

        const newQuantity = parseInt(input.value);
        
        if (isNaN(newQuantity) || newQuantity < sent) {
            alert(`Quantity must be at least ${sent} (the number already printed)`);
            input.value = input.min;
            return;
        }
        
        fetch('/update_order_quantity/' + orderId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                quantity: newQuantity 
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Update response:', data);
            if (data.success) {
                // The socket update will handle re-rendering the value, just close the form
                // The table update is skipped during editing, so we close the form
                window.cancelEditQuantity(orderId); 
            } else {
                alert(data.error || 'Failed to update quantity');
            }
        })
        .catch(error => {
            console.error('Error updating quantity:', error);
            alert('Error updating quantity: ' + error.message);
        });
    };
    
    // === End Order Quantity Functions ===

    window.updateOrders = function(data) {
        const tbody = document.getElementById('orderList');
        if (!tbody) return;

        // === SIMPLE FIX: Skip update completely if user is actively editing quantity ===
        const activeInput = document.activeElement;
        if (activeInput && activeInput.id && activeInput.id.startsWith('quantity-input-')) {
            console.log('Skipping order table update - user is editing quantity');
            return;
        }
        // === END SIMPLE FIX ===

        // Standard table rebuild without preservation logic
        tbody.innerHTML = data.orders.map(order => `
            <tr data-order-id="${order.id}">
                <td>${order.id}</td>
                <td>
                    <span class="job-name" data-original="${order.filename}">
                        ${window.maskJobName(order.filename)}
                    </span>
                </td>
                <td>
                    <span class="quantity-display ${order.sent >= order.quantity ? 'text-success' : ''}" 
                          data-order-id="${order.id}"
                          data-order-sent="${order.sent}"
                          data-order-quantity="${order.quantity}"
                          title="Click to edit quantity">
                        ${order.sent}/${order.quantity}
                        ${order.sent >= order.quantity ? '<span class="badge bg-success ms-1">‚úì</span>' : ''}
                    </span>
                    <div id="quantity-edit-${order.id}" class="quantity-edit-form" style="display: none;">
                        <span>${order.sent}/</span>
                        <input type="number" id="quantity-input-${order.id}" 
                               value="${order.quantity}" 
                               min="${order.sent}" 
                               class="form-control form-control-sm">
                        <button class="btn btn-success btn-sm" onclick="saveQuantity('${order.id}', ${order.sent})">‚úì</button>
                        <button class="btn btn-secondary btn-sm" onclick="cancelEditQuantity('${order.id}')">‚úó</button>
                    </div>
                </td>
                <td>${order.groups.join(', ')}</td>
                <td>
                    ${order.status === 'fulfilled' ? '<span class="badge bg-success">Fulfilled</span>' :
                      order.status === 'partial' ? '<span class="badge bg-warning">In Progress</span>' :
                      order.status === 'printing' ? '<span class="badge bg-primary">Printing</span>' :
                      `<span class="badge bg-secondary">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span>`}
                </td>
                <td>${order.ejection_enabled ? 'Enabled' : 'Disabled'}</td>
                <td>
                    <div class="order-controls">
                        <button class="btn btn-sm btn-outline-secondary" onclick="moveOrderUp('${order.id}')">‚Üë</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="moveOrderDown('${order.id}')">‚Üì</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order.id}')">Delete</button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    window.updateStats = function(data) {
        // Update stats values
        const stats = {
            ready: data.printers.filter(p => p.state === 'IDLE' || p.state === 'READY').length,
            printing: data.printers.filter(p => p.state === 'PRINTING').length,
            finished: data.printers.filter(p => p.state === 'FINISHED').length,
            stopped: data.printers.filter(p => p.state === 'STOPPED' || p.state === 'ATTENTION' || p.state === 'ERROR').length,
            offline: data.printers.filter(p => p.state === 'OFFLINE').length,
            total: data.printers.length
        };
        
        // Update DOM
        document.querySelector('.stat-ready .stat-value').textContent = stats.ready;
        document.querySelector('.stat-printing .stat-value').textContent = stats.printing;
        document.querySelector('.stat-finished .stat-value').textContent = stats.finished;
        document.querySelector('.stat-stopped .stat-value').textContent = stats.stopped;
        document.querySelector('.stat-offline .stat-value').textContent = stats.offline;
        document.querySelector('.stat-total .stat-value').textContent = stats.total;
    }

    window.updateEjectionStatus = function() {
        fetch('/ejection_status')
            .then(response => response.json())
            .then(data => {
                const ejectionToggle = document.getElementById('ejectionToggle');
                const ejectionStatusText = document.getElementById('ejectionStatusText');
                
                if (data.paused) {
                    ejectionToggle.checked = false;
                    ejectionStatusText.textContent = 'Paused';
                    ejectionStatusText.className = 'text-warning';
                } else {
                    ejectionToggle.checked = true;
                    ejectionStatusText.textContent = 'Active';
                    ejectionStatusText.className = 'text-success';
                }
            })
            .catch(error => {
                console.error('Error fetching ejection status:', error);
            });
    }

    window.toggleEjection = function() {
        const ejectionToggle = document.getElementById('ejectionToggle');
        const action = ejectionToggle.checked ? 'resume_ejection' : 'pause_ejection';
        
        fetch(`/${action}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (response.ok) {
                updateEjectionStatus();
            } else {
                console.error('Failed to toggle ejection');
                ejectionToggle.checked = !ejectionToggle.checked;
            }
        })
        .catch(error => {
            console.error('Error toggling ejection:', error);
            ejectionToggle.checked = !ejectionToggle.checked;
        });
    }

    window.showGroupEdit = function(printerName) {
        const form = document.getElementById(`groupForm-${printerName}`);
        if (form) {
            form.style.display = 'flex';
        }
    }

    window.hideGroupEdit = function(printerName) {
        const form = document.getElementById(`groupForm-${printerName}`);
        if (form) {
            form.style.display = 'none';
        }
    }

    // ENHANCED EJECTION FUNCTIONS START

    window.toggleEndGcodeSection = function() {
        const enableEjection = document.getElementById('enableEjection').checked;
        const section = document.getElementById('endGcodeSection');
        
        if (enableEjection) {
            section.style.display = 'block';
            // Focus on textarea for better UX
            setTimeout(() => {
                document.getElementById('endGcodeInput').focus();
            }, 100);
        } else {
            section.style.display = 'none';
            // Clear uploaded file indicator when hiding
            document.getElementById('uploadedFileName').style.display = 'none';
        }
    }

    window.uploadEjectionFile = function() {
        document.getElementById('ejectionFileInput').click();
    }

    window.handleEjectionFileUpload = function(input) {
        const file = input.files[0];
        if (!file) return;
        
        // Validate file type
        const validExtensions = ['.txt', '.gcode', '.gc', '.nc'];
        const fileName = file.name.toLowerCase();
        const isValid = validExtensions.some(ext => fileName.endsWith(ext));
        
        if (!isValid) {
            showToast('Please select a valid G-code file (.txt, .gcode, .gc, or .nc)', 'error');
            input.value = '';
            return;
        }
        
        // Show loading state
        const uploadBtn = document.getElementById('uploadEjectionBtn');
        const originalText = uploadBtn.innerHTML;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
        uploadBtn.disabled = true;
        
        // Read file content
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            
            // Insert content into textarea
            const textarea = document.getElementById('endGcodeInput');
            const currentContent = textarea.value.trim();
            
            if (currentContent) {
                // Ask user if they want to replace or append
                const action = confirm('You have existing G-code. Click OK to replace it, or Cancel to append the new code.');
                if (action) {
                    textarea.value = content;
                } else {
                    textarea.value = currentContent + '\n\n; --- Uploaded from ' + file.name + ' ---\n' + content;
                }
            } else {
                textarea.value = content;
            }
            
            // Show uploaded file indicator
            const fileIndicator = document.getElementById('uploadedFileName');
            fileIndicator.textContent = `‚úì Loaded: ${file.name}`;
            fileIndicator.style.display = 'inline';
            fileIndicator.className = 'text-success ms-2';
            
            // Auto-resize textarea if needed
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 300) + 'px';
            
            // Reset upload button
            uploadBtn.innerHTML = originalText;
            uploadBtn.disabled = false;
            
            // Clear file input for future uploads
            input.value = '';
            
            // Show success message
            showToast('G-code file loaded successfully!', 'success');
        };
        
        reader.onerror = function() {
            showToast('Error reading file. Please try again.', 'error');
            uploadBtn.innerHTML = originalText;
            uploadBtn.disabled = false;
            input.value = '';
        };
        
        reader.readAsText(file);
    }

    window.clearEjectionGcode = function() {
        if (confirm('Are you sure you want to clear the ejection G-code?')) {
            document.getElementById('endGcodeInput').value = '';
            document.getElementById('uploadedFileName').style.display = 'none';
            showToast('Ejection G-code cleared', 'info');
        }
    }

    window.saveDefaultEndGcode = function() {
        const defaultGcode = document.getElementById('endGcodeInput').value.trim();
        const ejectionEnabled = document.getElementById('enableEjection').checked;
        
        console.log('Saving default settings:', { defaultGcode, ejectionEnabled });
        
        // Show loading state
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Saving...';
        button.disabled = true;
        
        fetch('/save_default_end_gcode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                default_gcode: defaultGcode,
                ejection_enabled: ejectionEnabled
            })
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                // Show success feedback
                button.textContent = '‚úì Saved!';
                button.classList.add('btn-success');
                button.classList.remove('btn-secondary');
                
                showToast(data.message || 'Default settings saved successfully!', 'success');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-secondary');
                    button.disabled = false;
                }, 2000);
            } else {
                // Handle error case - check both data.message and data.error
                throw new Error(data.message || data.error || 'Failed to save default settings');
            }
        })
        .catch(error => {
            console.error('Error saving settings:', error);
            button.textContent = originalText;
            button.disabled = false;
            showToast('Failed to save settings: ' + error.message, 'error');
        });
    }

    // Toast notification function
    window.showToast = function(message, type = 'info') {
        // Create toast if it doesn't exist
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
            `;
            document.body.appendChild(toastContainer);
        }
        
        const toast = document.createElement('div');
        const colorClass = {
            'success': 'alert-success',
            'error': 'alert-danger',
            'info': 'alert-info',
            'warning': 'alert-warning'
        }[type] || 'alert-info';
        
        toast.className = `alert ${colorClass} alert-dismissible fade show`;
        toast.style.cssText = 'margin-bottom: 10px; min-width: 300px;';
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        toastContainer.appendChild(toast);
        
        // Auto-remove after 4 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 4000);
    }
    
    // ENHANCED EJECTION FUNCTIONS END

    window.handleStopSubmit = function(event, printerName) {
        if (!confirm(`Are you sure you want to stop the print on ${printerName}?`)) {
            return false;
        }
        
        const button = event.target.querySelector('button[type="submit"]');
        if (button) {
            button.disabled = true;
            button.classList.add('btn-stopping');
            button.textContent = 'Stopping...';
        }
        
        return true;
    }

    window.moveOrderUp = function(orderId) {
        const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
        if (!row) return;
        
        row.classList.add('order-moving-up');
        disableOrderControls();
        
        fetch('/move_order_up', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order_id: orderId })
        })
        .then(response => {
            if (response.ok) {
                showOrderMoveFeedback(row, 'up');
            } else {
                row.classList.remove('order-moving-up');
                enableOrderControls();
                console.error('Failed to move order up');
            }
        })
        .catch(error => {
            row.classList.remove('order-moving-up');
            enableOrderControls();
            console.error('Error moving order up:', error);
        });
    }

    window.moveOrderDown = function(orderId) {
        const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
        if (!row) return;
        
        row.classList.add('order-moving-down');
        disableOrderControls();
        
        fetch('/move_order_down', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order_id: orderId })
        })
        .then(response => {
            if (response.ok) {
                showOrderMoveFeedback(row, 'down');
            } else {
                row.classList.remove('order-moving-down');
                enableOrderControls();
                console.error('Failed to move order down');
            }
        })
        .catch(error => {
            row.classList.remove('order-moving-down');
            enableOrderControls();
            console.error('Error moving order down:', error);
        });
    }

    window.deleteOrder = function(orderId) {
        if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
            fetch('/delete_order/' + orderId, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_id: orderId })
            })
            .then(response => {
                if (response.ok) {
                    console.log(`Order ${orderId} deleted successfully`);
                } else {
                    console.error(`Failed to delete order ${orderId}:`, response.status);
                    alert('Failed to delete order. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error deleting order:', error);
                alert('Error deleting order: ' + error.message);
            });
        }
    }

    window.sortPrinters = function() {
        const container = document.getElementById('printersContainer');
        const sortSelect = document.getElementById('printerSort');
        if (!container || !sortSelect) return;
        
        const sortMethod = sortSelect.value;
        localStorage.setItem('printerSortMethod', sortMethod);
        
        const printerCards = Array.from(container.querySelectorAll('.printer-card'));
        
        printerCards.sort((a, b) => {
            switch(sortMethod) {
                case 'name-asc':
                    return naturalSort(a.dataset.name, b.dataset.name);
                case 'name-desc':
                    return naturalSort(b.dataset.name, a.dataset.name);
                case 'group-asc':
                    return a.dataset.group.localeCompare(b.dataset.group);
                case 'group-desc':
                    return b.dataset.group.localeCompare(a.dataset.group);
                case 'type-prusa':
                    const aIsPrusa = (a.dataset.type || 'prusa') === 'prusa';
                    const bIsPrusa = (b.dataset.type || 'prusa') === 'prusa';
                    if (aIsPrusa && !bIsPrusa) return -1;
                    if (!aIsPrusa && bIsPrusa) return 1;
                    return naturalSort(a.dataset.name, b.dataset.name);
                case 'type-bambu':
                    const aIsBambu = (a.dataset.type || 'prusa') === 'bambu';
                    const bIsBambu = (b.dataset.type || 'prusa') === 'bambu';
                    if (aIsBambu && !bIsBambu) return -1;
                    if (!aIsBambu && bIsBambu) return 1;
                    return naturalSort(a.dataset.name, b.dataset.name);
                case 'status-ready':
                case 'status-printing':
                case 'status-finished':
                case 'status-offline':
                case 'status-service':
                    const targetStatus = sortMethod.replace('status-', '');
                    const aHasStatus = getStatusFromCard(a) === targetStatus;
                    const bHasStatus = getStatusFromCard(b) === targetStatus;
                    if (aHasStatus && !bHasStatus) return -1;
                    if (!aHasStatus && bHasStatus) return 1;
                    return naturalSort(a.dataset.name, b.dataset.name);
                default:
                    return 0;
            }
        });
        
        printerCards.forEach(card => container.appendChild(card));
    }

    function naturalSort(a, b) {
        const aParts = a.match(/(\d+|\D+)/g) || [];
        const bParts = b.match(/(\d+|\D+)/g) || [];
        
        for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
            const aPart = aParts[i] || '';
            const bPart = bParts[i] || '';
            
            const aIsNum = /^\d+$/.test(aPart);
            const bIsNum = /^\d+$/.test(bPart);
            
            if (aIsNum && bIsNum) {
                const diff = parseInt(aPart) - parseInt(bPart);
                if (diff !== 0) return diff;
            } else {
                const diff = aPart.localeCompare(bPart);
                if (diff !== 0) return diff;
            }
        }
        
        return 0;
    }

    function getStatusFromCard(card) {
        const statusIndicator = card.querySelector('.status-indicator');
        if (statusIndicator.classList.contains('ready')) return 'ready';
        if (statusIndicator.classList.contains('printing')) return 'printing';
        if (statusIndicator.classList.contains('paused')) return 'paused';
        if (statusIndicator.classList.contains('finished')) return 'finished';
        if (statusIndicator.classList.contains('service')) return 'service';
        if (statusIndicator.classList.contains('offline')) return 'offline';
        return 'unknown';
    }

    function loadSavedSort() {
        const savedSort = localStorage.getItem('printerSortMethod');
        const sortSelect = document.getElementById('printerSort');
        
        if (savedSort && sortSelect) {
            sortSelect.value = savedSort;
            window.sortPrinters();
        }
    }

    function applySavedSort() {
        const savedSort = localStorage.getItem('printerSortMethod');
        const sortSelect = document.getElementById('printerSort');
        
        if (savedSort && sortSelect) {
            if (sortSelect.value !== savedSort) {
                sortSelect.value = savedSort;
            }
            window.sortPrinters();
        }
    }

    function loadCompactViewPreference() {
        const savedCompactView = localStorage.getItem('compactView');
        if (savedCompactView === 'true') {
            document.getElementById('compactViewToggle').checked = true;
            window.compactView = true;
            document.body.classList.add('compact-view');
            addCompactViewClickHandlers();
        }
    }

    function showOrderMoveFeedback(row, direction) {
        row.classList.add('order-moved-highlight');
        
        const indicator = document.createElement('div');
        indicator.className = `order-move-indicator ${direction}`;
        indicator.innerHTML = direction === 'up' ? '‚Üë Moved Up' : '‚Üì Moved Down';
        
        const rect = row.getBoundingClientRect();
        indicator.style.position = 'fixed';
        indicator.style.left = (rect.right - 100) + 'px';
        indicator.style.top = (rect.top + rect.height / 2 - 15) + 'px';
        indicator.style.zIndex = '1000';
        
        document.body.appendChild(indicator);
        
        setTimeout(() => indicator.classList.add('show'), 10);
        
        setTimeout(() => {
            indicator.remove();
            row.classList.remove('order-moved-highlight', `order-moving-${direction}`);
            enableOrderControls();
        }, 1500);
    }

    function disableOrderControls() {
        document.querySelectorAll('.order-controls button').forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.5';
        });
    }

    function enableOrderControls() {
        document.querySelectorAll('.order-controls button').forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = '1';
        });
    }
    
    // === NEW: Event Delegation Handler for Quantity Clicks ===
    function handleQuantityClick(e) {
        const target = e.target.closest('.quantity-display');
        if (target) {
            e.preventDefault();
            e.stopPropagation();
            const orderId = target.dataset.orderId;
            const sent = parseInt(target.dataset.orderSent);
            const quantity = parseInt(target.dataset.orderQuantity);
            
            // Call the globally defined function
            window.editQuantity(orderId, sent, quantity);
        }
    }
    // === END NEW HANDLER ===


    document.addEventListener('DOMContentLoaded', () => {
        // Load saved sort method when page loads
        loadSavedSort();
        
        // Load compact view preference
        loadCompactViewPreference();
        
        // Update ejection status on page load
        window.updateEjectionStatus();
        
        // Initialize the ejection section based on the checkbox state
        const enableEjection = document.getElementById('enableEjection');
        if (enableEjection) {
            window.toggleEndGcodeSection();
        }
        
        // Initialize dropdown checkboxes to maintain checked state
        document.querySelectorAll('.group-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                event.stopPropagation();
            });
        });
        
        // Prevent dropdown from closing when clicking inside
        const dropdownMenu = document.querySelector('.checkbox-dropdown-menu');
        if (dropdownMenu) {
            dropdownMenu.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        // === FIX: Attach ONE event listener to the orders table for delegation ===
        const ordersTable = document.getElementById('ordersTable');
        if (ordersTable) {
            ordersTable.addEventListener('click', handleQuantityClick);
        }
        
        // Add keyboard support for quantity editing
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.quantity-edit-form').forEach(form => {
                    if (form.style.display !== 'none') {
                        const orderId = form.id.replace('quantity-edit-', '');
                        window.cancelEditQuantity(orderId);
                    }
                });
            } else if (e.key === 'Enter') {
                if (e.target.id && e.target.id.startsWith('quantity-input-')) {
                    e.preventDefault();
                    const orderId = e.target.id.replace('quantity-input-', '');
                    
                    // --- ENHANCEMENT START ---
                    const row = e.target.closest('tr');
                    const quantityDisplay = row?.querySelector('.quantity-display');
                    const sent = quantityDisplay ? parseInt(quantityDisplay.dataset.orderSent) : null;
                    
                    if (sent !== null && !isNaN(sent)) {
                        window.saveQuantity(orderId, sent);
                    } else {
                        console.error("Could not determine sent quantity for Enter key save.");
                    }
                    // --- ENHANCEMENT END ---
                }
            }
        });
        
        // Drag and drop support for the ejection file
        const textarea = document.getElementById('endGcodeInput');
        if (textarea) {
            // Drag and drop functionality
            textarea.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('dragover');
            });
            
            textarea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('dragover');
            });
            
            textarea.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const input = document.getElementById('ejectionFileInput');
                    input.files = files;
                    handleEjectionFileUpload(input);
                }
            });
        }
    });
</script>
{% endblock %}